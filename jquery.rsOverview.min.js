// Overview plug-in v3.3 - MIT license - ruisoftware.com
(function(a){var b=function(f,b,l){var i=null,g=null,k=b.monitor===window||a(b.monitor).is(a(window)),j=false,e={scaleCoef:0,scrPixels:{x:l,y:l}},h={$obj:null,sizeX:0,sizeY:0,resized:function(){this.sizeX=this.$obj.width();this.sizeY=this.$obj.height()},resizedOverflow:function(){var a=this.$obj[0].children.length==1?this.$obj[0].children[0].children.length>0?this.$obj[0].children[0]:this.$obj[0]:this.$obj[0];this.sizeX=a.scrollWidth;this.sizeY=a.scrollHeight}},d={$obj:null,sizeX:0,sizeY:0,resized:function(){this.sizeX=this.$obj.width();this.sizeY=this.$obj.height()}},c={states:{toggle:null,toggleIdx:null,triggerToggle:function(e,d){var a=d>-1;if(a!==this.toggle||a&&d!=this.toggleIdx){if(b.bookmarkActiveClass){c.$allBks.removeClass(b.bookmarkActiveClass);a&&c.$allBks.eq(d).addClass(b.bookmarkActiveClass)}if(a)c.currIdx=d;if(a!==this.toggle&&b.onChangeToggle)b.onChangeToggle(e,a);this.toggle=a;this.toggleIdx=d}},prev:null,triggerPrev:function(c,a){if(b.onChangeCtrlState&&a!==this.prev){this.prev=a;b.onChangeCtrlState(c,"prev",this.prev)}},next:null,triggerNext:function(c,a){if(b.onChangeCtrlState&&a!==this.next){this.next=a;b.onChangeCtrlState(c,"next",this.next)}},clearAll:null,triggerClearAll:function(c,a){if(b.onChangeCtrlState&&a!==this.clearAll){this.clearAll=a;b.onChangeCtrlState(c,"clear",this.clearAll)}}},$allBks:a(),currIdx:-1,qt:0,marks:[],getPnt:function(a){switch(b.direction){case"horizontal":return{scrollLeft:a};case"vertical":return{scrollTop:a};default:return{scrollLeft:a[0],scrollTop:a[1]}}},checkEvents:function(a){if(b.bookmarkClass){this.states.triggerToggle(a,this.getMarkedIdx());if(b.onChangeCtrlState){this.states.triggerPrev(a,this.currIdx>0||this.states.toggle===false&&this.currIdx===0);this.states.triggerNext(a,this.currIdx<this.qt-1);this.states.triggerClearAll(a,this.qt>0)}}},arrayIndexOf:function(d){switch(b.direction){case"horizontal":case"vertical":return a.inArray(d,this.marks);default:for(var c=0;c<this.marks.length;++c){var e=this.marks[c];if(e[0]==d[0]&&e[1]==d[1])return c}}return-1},doToggle:function(i,k,l){var j=b.direction=="horizontal"?k:b.direction=="vertical"?l:[k,l],e=this.arrayIndexOf(j);if(e===-1){var h=g.position(),d=a("<span>").addClass(b.bookmarkClass).css("position","absolute").appendTo(f);b.bookmarkHint&&d.attr("title",b.bookmarkHint);switch(b.direction){case"horizontal":d.css({left:Math.round(h.left+(g.width()-d.outerWidth())/2)+"px",top:0,bottom:0,height:"auto"});break;case"vertical":d.css({left:0,right:0,width:"auto",top:Math.round(h.top+(g.height()-d.outerHeight())/2)+"px"});break;default:d.css({left:Math.round(h.left+(g.width()-d.outerWidth())/2)+"px",top:Math.round(h.top+(g.height()-d.outerHeight())/2)+"px"})}d.mousedown(function(d){if(!b.readonly){var a=c.$allBks.index(this);a>-1&&a<c.qt&&m(c.getPnt(c.marks[a]),function(){c.checkEvents(d)});return false}});this.marks.push(j);this.$allBks=this.$allBks.add(d);this.qt=this.marks.length;this.currIdx=this.qt-1}else{this.marks.splice(e,1);this.$allBks.eq(e).remove();this.$allBks.splice(e,1);this.qt=this.marks.length;if(this.currIdx>=this.qt)this.currIdx=this.qt-1}i&&this.checkEvents(i)},toggle:function(a){this.doToggle(a,h.$obj.scrollLeft(),h.$obj.scrollTop())},doClearAll:function(b){this.marks.length=0;this.qt=0;this.currIdx=-1;this.$allBks.remove();this.$allBks=a();b&&this.checkEvents(b)},clearAll:function(a){this.doClearAll(a)},go:function(a,b){if(a>-1&&a<this.qt){m(this.getPnt(this.marks[a]),b);return true}return false},gotoPrev:function(a){if(this.currIdx>0||this.states.toggle===false){if(this.states.toggle!==false)this.currIdx--;this.go(this.currIdx,function(){c.checkEvents(a)})}},gotoNext:function(a){if(this.currIdx<this.qt-1){this.currIdx++;this.go(this.currIdx,function(){c.checkEvents(a)})}},getMarkedIdx:function(){switch(b.direction){case"horizontal":return a.inArray(h.$obj.scrollLeft(),this.marks);case"vertical":return a.inArray(h.$obj.scrollTop(),this.marks);default:return this.arrayIndexOf([h.$obj.scrollLeft(),h.$obj.scrollTop()])}},isInteger:function(a){return typeof a==="number"&&a%1===0},parseLoad:function(d){var e=[];if(d)if(d instanceof Array){var f=d.length;if(b.direction=="horizontal"||b.direction=="vertical")for(var c=0;c<f;++c){var a=d[c];if(this.isInteger(a))e.push(a);else throw"Invalid element "+a+" at index "+c+". Expected an integer. Example: [0, 34, 23]";}else for(var c=0;c<f;++c){var a=d[c];if(a instanceof Array&&a.length===2&&this.isInteger(a[0])&&this.isInteger(a[1])){e.push(a);continue}throw"Invalid element "+a+" at index "+c+". Expected a [x, y] two integers array. Example: [[0, 0], [40, 80], [40, 300]]";}}else switch(b.direction){case"horizontal":case"vertical":throw"Expected an array of integers. Example: [0, 80, 300]";default:throw"Expected an array of [x, y] arrays, where x and y are integers. Example: [[0, 0], [40, 80], [40, 300]]";}return e},loadMarks:function(h,g){try{var c=this.parseLoad(g),e=c.length;this.doClearAll(null);if(b.direction=="horizontal"||b.direction=="vertical")for(var a=0;a<e;++a)this.doToggle(null,c[a],c[a]);else for(var a=0;a<e;++a)this.doToggle(null,c[a][0],c[a][1]);f.triggerHandler("resize.rsOverview");this.checkEvents(h)}catch(i){var d="rsOverview.loadMarks(): "+i;if(window.console)console.error(d);else alert(d)}}},m=function(f,i){var h=k?a("html,body"):d.$obj;j&&h.stop(true);var e=[0,0],g;h.each(function(){var b=a(this),c=b.scrollLeft(),d=b.scrollTop();if(c!=0||d!=0){e[0]=c;e[1]=d;return false}});switch(b.direction){case"horizontal":g=e[0]!=f.scrollLeft;break;case"vertical":g=e[1]!=f.scrollTop;break;default:g=e[0]!=f.scrollLeft||e[1]!=f.scrollTop}if(g){b.bookmarkClass&&b.bookmarkActiveClass&&c.$allBks.removeClass(b.bookmarkActiveClass);j=true;h.animate(f,{duration:b.scrollSpeed,queue:false,complete:function(){j=false;i!==undefined&&i()}})}},n=function(){return h.sizeX<=d.sizeX?0:e.scrPixels.x},o=function(){return h.sizeY<=d.sizeY?0:e.scrPixels.y},A=function(){var p=function(){switch(b.direction){case"horizontal":return h.sizeX<=d.sizeX;case"vertical":return h.sizeY<=d.sizeY;default:return h.sizeX<=d.sizeX&&h.sizeY<=d.sizeY}};if(k)h.resized();else{h.resizedOverflow();var m=[d.$obj.css("overflow-x"),d.$obj.css("overflow-y")];e.scrPixels.x=m[0]=="hidden"?0:l;e.scrPixels.y=m[1]=="hidden"?0:l}d.resized();if(b.autoHide){if(p()){f.hide();return}f.show()}else f.css("display")=="none"&&f.show();var a={x:f.width(),y:f.height()},c=coefY=0;if(b.direction!="vertical")c=h.sizeX/a.x;if(b.direction!="horizontal")coefY=h.sizeY/a.y;e.scaleCoef=Math.max(c,coefY);if(b.direction!="vertical")c=(d.sizeX-o())/a.x;if(b.direction!="horizontal")coefY=(d.sizeY-n())/a.y;e.scaleCoef=Math.max(Math.max(c,coefY),e.scaleCoef);if(b.direction!="horizontal"&&b.direction!="vertical"){var j=h.sizeX/e.scaleCoef,g=h.sizeY/e.scaleCoef;i.width(Math.round(j)).height(Math.round(g)).css({left:Math.round(b.center?(a.x-j)/2:0)+"px",top:Math.round(b.center?(a.y-g)/2:0)+"px"})}f.triggerHandler("render.rsOverview",[true])},q=function(h){if(h){var b=(d.sizeX-o())/e.scaleCoef;g.width(Math.round(b));for(var a=0;a<c.marks.length;++a){var i=c.getPnt(c.marks[a]),f=c.$allBks.eq(a);f.css({left:Math.round((b-f.outerWidth())/2+i.scrollLeft/e.scaleCoef)+"px",top:0,bottom:0})}}g.css("left",Math.round(d.$obj.scrollLeft()/e.scaleCoef)+"px")},r=function(h){if(h){var b=(d.sizeY-n())/e.scaleCoef;g.height(Math.round(b));for(var a=0;a<c.marks.length;++a){var i=c.getPnt(c.marks[a]),f=c.$allBks.eq(a);f.css({top:Math.round((b-f.outerHeight())/2+i.scrollTop/e.scaleCoef)+"px",left:0,right:0})}}g.css("top",Math.round(d.$obj.scrollTop()/e.scaleCoef)+"px")},s=function(a,l){if(l){var j=(d.sizeX-o())/e.scaleCoef,i=(d.sizeY-n())/e.scaleCoef;g.width(Math.round(j)).height(Math.round(i));for(var f=0;f<c.marks.length;++f){var k=c.getPnt(c.marks[f]),h=c.$allBks.eq(f);h.css({left:Math.round(a.left+(j-h.outerWidth())/2+k.scrollLeft/e.scaleCoef)+"px",top:Math.round(a.top+(i-h.outerHeight())/2+k.scrollTop/e.scaleCoef)+"px"})}}a.left=d.$obj.scrollLeft()/e.scaleCoef+(b.center?a.left:0);a.top=d.$obj.scrollTop()/e.scaleCoef+(b.center?a.top:0);g.css({left:Math.round(a.left)+"px",top:Math.round(a.top)+"px"})},z=function(d,a){switch(b.direction){case"horizontal":q(a);break;case"vertical":r(a);break;default:s(i.position(),a)}!j&&c.checkEvents(d)},t=function(a){var c={x:0,y:0};if(a.wheelDelta===undefined&&a.originalEvent!==undefined&&(a.originalEvent.wheelDelta!==undefined||a.originalEvent.detail!==undefined))a=a.originalEvent;if(a.wheelDelta)c.y=a.wheelDelta/120;if(a.detail)c.y=-a.detail/3;var e=a||window.event;if(e.axis!==undefined&&e.axis===e.HORIZONTAL_AXIS){c.x=-c.y;c.y=0}if(e.wheelDeltaY!==undefined)c.y=e.wheelDeltaY/120;if(e.wheelDeltaX!==undefined)c.x=-e.wheelDeltaX/120;a.preventDefault?a.preventDefault():(a.returnValue=false);if(b.direction=="horizontal")d.$obj.scrollLeft(d.$obj.scrollLeft()-c.y*b.mousewheel);else d.$obj.scrollTop(d.$obj.scrollTop()-c.y*b.mousewheel);return false},u=function(a){b.bookmarkClass&&c.toggle(a)},v=function(a){b.bookmarkClass&&c.clearAll(a)},y=function(a){b.bookmarkClass&&c.gotoPrev(a)},x=function(a){b.bookmarkClass&&c.gotoNext(a)},p=function(d,a){switch(a){case"bookmarks":return c.marks;case"readonly":return b.readonly;case"center":return b.center;case"autoHide":return b.autoHide;case"scrollSpeed":return b.scrollSpeed}return null},B=function(d,e,a){switch(e){case"bookmarks":b.bookmarkClass&&c.loadMarks(d,a);break;case"readonly":b.readonly=a;break;case"center":b.center=a;f.triggerHandler("resize.rsOverview");break;case"autoHide":b.autoHide=a;f.triggerHandler("resize.rsOverview");break;case"scrollSpeed":b.scrollSpeed=a}return p(d,e)},w=function(a){if(b.onCreate)b.onCreate(a)},C=function(){i=a("<span>").addClass(b.contentClass).css("position","absolute");g=a("<span>").addClass(b.viewportClass).css("position","absolute");f.append(i).append(g);(b.direction=="horizontal"||b.direction=="vertical")&&i.css({left:0,top:0,bottom:0,right:0});switch(b.direction){case"horizontal":g.css({top:0,bottom:0});break;case"vertical":g.css({left:0,right:0})}d.$obj=a(b.monitor);if(k)h.$obj=a(document);else h.$obj=d.$obj;d.$obj.scroll(function(){f.triggerHandler("render.rsOverview",[false])}).resize(function(){f.triggerHandler("resize.rsOverview")});b.mousewheel!==0&&(k?a(window):d.$obj).bind("DOMMouseScroll.rsOverview mousewheel.rsOverview",t);g.mousedown(function(h){if(!b.readonly){if(j){(k?a("html,body"):d.$obj).stop(true);j=false}var c={initPos:g.offset(),initClick:{x:h.pageX,y:h.pageY}};this.onselectstart=function(){return false};a(document).bind("mousemove.rsOverview",function(g){switch(b.direction){case"horizontal":d.$obj.scrollLeft(e.scaleCoef*(g.pageX-c.initClick.x+c.initPos.left-f.position().left));break;case"vertical":d.$obj.scrollTop(e.scaleCoef*(g.pageY-c.initClick.y+c.initPos.top-f.position().top));break;default:var a=[f.position(),i.position()];d.$obj.scrollLeft(e.scaleCoef*(g.pageX-c.initClick.x+c.initPos.left-a[0].left-a[1].left)).scrollTop(e.scaleCoef*(g.pageY-c.initClick.y+c.initPos.top-a[0].top-a[1].top))}});h.preventDefault()}});a(document).mouseup(function(){!b.readonly&&a(document).unbind("mousemove.rsOverview")});if(b.direction=="horizontal"||b.direction=="vertical")i.mousedown(function(a){if(!b.readonly){var h=f.position(),d=b.direction=="horizontal"?a.pageX-h.left-g.width()/2:a.pageY-h.top-g.height()/2;d*=e.scaleCoef;m(b.direction=="horizontal"?{scrollLeft:d}:{scrollTop:d},function(){c.checkEvents(a)});a.preventDefault()}});else i.mousedown(function(h){if(!b.readonly){var d={container:f.position(),content:a(this).position()},i={scrollLeft:e.scaleCoef*(h.pageX-d.container.left-d.content.left-g.width()/2),scrollTop:e.scaleCoef*(h.pageY-d.container.top-d.content.top-g.height()/2)};m(i,function(){c.checkEvents(h)});h.preventDefault()}});f.bind("resize.rsOverview",A).bind("render.rsOverview",z).bind("toggleBk.rsOverview",u).bind("clearBk.rsOverview",v).bind("prevBk.rsOverview",y).bind("nextBk.rsOverview",x).bind("getter.rsOverview",p).bind("setter.rsOverview",B).bind("create.rsOverview",w);f.triggerHandler("resize.rsOverview");f.triggerHandler("create.rsOverview")};C()};a.fn.rsOverview=function(c){var k=function(){return this.trigger("resize.rsOverview")},j=function(){return this.trigger("toggleBk.rsOverview")},e=function(){return this.trigger("clearBk.rsOverview")},g=function(){return this.trigger("prevBk.rsOverview")},f=function(){return this.trigger("nextBk.rsOverview")},m=function(){if(typeof arguments[0]=="string"){var a=arguments.length==1?"getter":arguments.length==2?"setter":null;if(a!=null)return this.eq(0).triggerHandler(a+".rsOverview",arguments)}};if(typeof c=="string"){var l=Array.prototype.slice.call(arguments,1);switch(c){case"invalidate":return k.apply(this);case"toggleBk":return j.apply(this);case"clearBk":return e.apply(this);case"prevBk":return g.apply(this);case"nextBk":return f.apply(this);case"option":return m.apply(this,l);default:return this}}var d=a.extend({},a.fn.rsOverview.defaults,c),h=function(){var c=a("<div style='visibily: hidden; overflow: scroll; width: 100px;'></div>");a("body").append(c);try{var b=c[0].clientWidth;return 100-(b==100||b==0?83:b)}finally{c.remove()}},i=d.monitor===window||a(d.monitor).is(a(window))?0:h();return this.each(function(){new b(a(this),d,i)})};a.fn.rsOverview.defaults={monitor:a(window),direction:"both",center:true,autoHide:false,readonly:false,scrollSpeed:"normal",bookmarkClass:"bookm",bookmarkActiveClass:"active",bookmarkHint:"Go to bookmark",contentClass:"content",viewportClass:"viewport",mousewheel:0,onCreate:null,onChangeCtrlState:null,onChangeToggle:null}})(jQuery)
