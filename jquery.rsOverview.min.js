// Overview plug-in v3.1 - ruisoftware.com
(function(a){var b=function(e,b,k){var i=null,h=null,l=b.monitor===window||a(b.monitor).is(a(window)),j=false,f={scaleCoef:0,scrPixels:{x:k,y:k}},g={$obj:null,sizeX:0,sizeY:0,resized:function(){this.sizeX=this.$obj.width();this.sizeY=this.$obj.height()},resizedOverflow:function(){var a=this.$obj[0].children.length==1?this.$obj[0].children[0].children.length>0?this.$obj[0].children[0]:this.$obj[0]:this.$obj[0];this.sizeX=a.scrollWidth;this.sizeY=a.scrollHeight}},d={$obj:null,sizeX:0,sizeY:0,resized:function(){this.sizeX=this.$obj.width();this.sizeY=this.$obj.height()}},c={states:{toggle:null,toggleIdx:null,triggerToggle:function(e,d){var a=d>-1;if(a!==this.toggle||a&&d!=this.toggleIdx){if(b.bookmarkActiveClass){c.$allBks.removeClass(b.bookmarkActiveClass);a&&c.$allBks.eq(d).addClass(b.bookmarkActiveClass)}if(a)c.currIdx=d;if(a!==this.toggle&&b.onChangeToggle)b.onChangeToggle(e,a);this.toggle=a;this.toggleIdx=d}},prev:null,triggerPrev:function(c,a){if(b.onChangeCtrlState&&a!==this.prev){this.prev=a;b.onChangeCtrlState(c,"prev",this.prev)}},next:null,triggerNext:function(c,a){if(b.onChangeCtrlState&&a!==this.next){this.next=a;b.onChangeCtrlState(c,"next",this.next)}},clearAll:null,triggerClearAll:function(c,a){if(b.onChangeCtrlState&&a!==this.clearAll){this.clearAll=a;b.onChangeCtrlState(c,"clear",this.clearAll)}}},$allBks:a(),currIdx:-1,qt:0,marks:[],getPnt:function(b){var a=b.split("#");return{scrollLeft:parseInt(a[0],10),scrollTop:parseInt(a[1],10)}},checkEvents:function(a){if(b.bookmarkClass){this.states.triggerToggle(a,this.getMarkedIdx());if(b.onChangeCtrlState){this.states.triggerPrev(a,this.currIdx>0||this.states.toggle===false&&this.currIdx===0);this.states.triggerNext(a,this.currIdx<this.qt-1);this.states.triggerClearAll(a,this.qt>0)}}},doToggle:function(g,k,l){var i=k+"#"+l,f=a.inArray(i,this.marks);if(f===-1){var j=h.position(),d=a("<div>").addClass(b.bookmarkClass).appendTo(e);b.bookmarkHint&&d.attr("title",b.bookmarkHint);d.css({position:"absolute",left:Math.round(j.left+(h.width()-d.outerWidth())/2)+"px",top:Math.round(j.top+(h.height()-d.outerHeight())/2)+"px"}).mousedown(function(d){if(!b.readonly){var a=c.$allBks.index(this);a>-1&&a<c.qt&&m(c.getPnt(c.marks[a]),function(){c.checkEvents(d)});return false}});this.marks.push(i);this.$allBks=this.$allBks.add(d);this.qt=this.marks.length;this.currIdx=this.qt-1}else{this.marks.splice(f,1);this.$allBks.eq(f).remove();this.$allBks.splice(f,1);this.qt=this.marks.length;if(this.currIdx>=this.qt)this.currIdx=this.qt-1}g&&this.checkEvents(g)},toggle:function(a){this.doToggle(a,g.$obj.scrollLeft(),g.$obj.scrollTop())},doClearAll:function(b){this.marks.length=0;this.qt=0;this.currIdx=-1;this.$allBks.remove();this.$allBks=a();b&&this.checkEvents(b)},clearAll:function(a){this.doClearAll(a)},go:function(a,b){if(a>-1&&a<this.qt){m(this.getPnt(this.marks[a]),b);return true}return false},gotoPrev:function(a){if(this.currIdx>0||this.states.toggle===false){if(this.states.toggle!==false)this.currIdx--;this.go(this.currIdx,function(){c.checkEvents(a)})}},gotoNext:function(a){if(this.currIdx<this.qt-1){this.currIdx++;this.go(this.currIdx,function(){c.checkEvents(a)})}},getMarkedIdx:function(){return a.inArray(g.$obj.scrollLeft()+"#"+g.$obj.scrollTop(),this.marks)},parseLoad:function(b){var e=[];if(b)if(b instanceof Array)for(var f in b){var c=b[f];if(c){try{var a=c.split("#")}catch(g){a=null}if(a&&a.length===2){var d=[parseInt(a[0],10),parseInt(a[1],10)];if(!isNaN(d[0])&&!isNaN(d[1])){e.push(d);continue}}}throw"Invalid element "+c+" at index "+f+'. Expected a "x#y" string object, where x and y are integers. Example: ["0#0","40#80","40#300"]';}else throw'Expected an array of strings "x#y", where x and y are integers. Example: ["0#0","40#80","40#300"]';return e},loadMarks:function(f,d){try{var a=this.parseLoad(d);this.doClearAll(null);for(var c in a)this.doToggle(null,a[c][0],a[c][1]);e.triggerHandler("resize.rsOverview");this.checkEvents(f)}catch(g){var b="rsOverview.loadMarks(): "+g;if(window.console)console.error(b);else alert(b)}}},m=function(f,c){var e=l?a("body,html"):d.$obj;j&&e.stop(true);j=true;e.animate(f,b.scrollSpeed,function(){j=false;c!==undefined&&c()})},n=function(){return g.sizeX<=d.sizeX?0:f.scrPixels.x},o=function(){return g.sizeY<=d.sizeY?0:f.scrPixels.y},w=function(){if(l)g.resized();else{g.resizedOverflow();var p=[d.$obj.css("overflow-x"),d.$obj.css("overflow-y")];f.scrPixels.x=p[0]=="hidden"?0:k;f.scrPixels.y=p[1]=="hidden"?0:k}d.resized();if(b.autoHide){if(g.sizeX<=d.sizeX&&g.sizeY<=d.sizeY){e.hide();return}e.show()}else e.is(":hidden")&&e.show();var a={x:e.width(),y:e.height()},c=g.sizeX/a.x,h=g.sizeY/a.y;f.scaleCoef=Math.max(c,h);c=(d.sizeX-o())/a.x;h=(d.sizeY-n())/a.y;f.scaleCoef=Math.max(Math.max(c,h),f.scaleCoef);var m=g.sizeX/f.scaleCoef,j=g.sizeY/f.scaleCoef;i.width(Math.round(m)).height(Math.round(j)).css({left:Math.round(b.center?(a.x-m)/2:0)+"px",top:Math.round(b.center?(a.y-j)/2:0)+"px"});e.triggerHandler("render.rsOverview",[true])},v=function(q,p){var a=i.position();if(p){var k=(d.sizeX-o())/f.scaleCoef,g=(d.sizeY-n())/f.scaleCoef;h.width(Math.round(k)).height(Math.round(g));for(var m in c.marks){var l=c.getPnt(c.marks[m]),e=c.$allBks.eq(m);e.css({left:Math.round(a.left+(k-e.outerWidth())/2+l.scrollLeft/f.scaleCoef)+"px",top:Math.round(a.top+(g-e.outerHeight())/2+l.scrollTop/f.scaleCoef)+"px"})}}a.left=d.$obj.scrollLeft()/f.scaleCoef+(b.center?a.left:0);a.top=d.$obj.scrollTop()/f.scaleCoef+(b.center?a.top:0);h.css({left:Math.round(a.left)+"px",top:Math.round(a.top)+"px"});!j&&c.checkEvents(q)},q=function(a){b.bookmarkClass&&c.toggle(a)},r=function(a){b.bookmarkClass&&c.clearAll(a)},u=function(a){b.bookmarkClass&&c.gotoPrev(a)},t=function(a){b.bookmarkClass&&c.gotoNext(a)},p=function(d,a){switch(a){case"bookmarks":return c.marks;case"readonly":return b.readonly;case"center":return b.center;case"autoHide":return b.autoHide;case"scrollSpeed":return b.scrollSpeed}return null},x=function(d,f,a){switch(f){case"bookmarks":b.bookmarkClass&&c.loadMarks(d,a);break;case"readonly":b.readonly=a;break;case"center":b.center=a;e.triggerHandler("resize.rsOverview");break;case"autoHide":b.autoHide=a;e.triggerHandler("resize.rsOverview");break;case"scrollSpeed":b.scrollSpeed=a}return p(d,f)},s=function(a){if(b.onCreate)b.onCreate(a)},y=function(){i=a("<div>").addClass(b.contentClass).css({overflow:"hidden",position:"absolute"});h=a("<div>").addClass(b.viewportClass).css("position","absolute");e.append(i).append(h);d.$obj=a(b.monitor);if(l)g.$obj=a(document);else g.$obj=d.$obj;d.$obj.scroll(function(){e.triggerHandler("render.rsOverview",[false])}).resize(function(){e.triggerHandler("resize.rsOverview")});h.mousedown(function(g){if(!b.readonly){if(j){(l?a("body,html"):d.$obj).stop(true);j=false}var c={initPos:h.offset(),initClick:{X:g.pageX,Y:g.pageY}};this.onselectstart=function(){return false};h.bind("mousemove.rsOverview",function(b){var a=[e.position(),i.position()];d.$obj.scrollLeft(f.scaleCoef*(b.pageX-c.initClick.X+c.initPos.left-a[0].left-a[1].left)).scrollTop(f.scaleCoef*(b.pageY-c.initClick.Y+c.initPos.top-a[0].top-a[1].top))});g.preventDefault()}});a("body").mouseup(function(){!b.readonly&&h.unbind("mousemove.rsOverview")});i.mousedown(function(g){if(!b.readonly){var d={container:e.position(),content:a(this).position()},i={scrollLeft:f.scaleCoef*(g.pageX-d.container.left-d.content.left-h.width()/2),scrollTop:f.scaleCoef*(g.pageY-d.container.top-d.content.top-h.height()/2)};m(i,function(){c.checkEvents(g)});g.preventDefault()}});e.bind("resize.rsOverview",w).bind("render.rsOverview",v).bind("toggleBk.rsOverview",q).bind("clearBk.rsOverview",r).bind("prevBk.rsOverview",u).bind("nextBk.rsOverview",t).bind("getter.rsOverview",p).bind("setter.rsOverview",x).bind("create.rsOverview",s);e.triggerHandler("resize.rsOverview");e.triggerHandler("create.rsOverview")};y()};a.fn.rsOverview=function(c){var e=function(){return this.trigger("resize.rsOverview")},k=function(){return this.trigger("toggleBk.rsOverview")},f=function(){return this.trigger("clearBk.rsOverview")},h=function(){return this.trigger("prevBk.rsOverview")},g=function(){return this.trigger("nextBk.rsOverview")},m=function(){if(typeof arguments[0]=="string"){var a=arguments.length==1?"getter":arguments.length==2?"setter":null;if(a!=null)return this.eq(0).triggerHandler(a+".rsOverview",arguments)}};if(typeof c=="string"){var l=Array.prototype.slice.call(arguments,1);switch(c){case"contentSizeChanged":return e.apply(this);case"toggleBk":return k.apply(this);case"clearBk":return f.apply(this);case"prevBk":return h.apply(this);case"nextBk":return g.apply(this);case"option":return m.apply(this,l);default:return this}}var d=a.extend({},a.fn.rsOverview.defaults,c),i=function(){var c=a("<div style='visibily: hidden; overflow: scroll; width: 100px;'></div>");a("body").append(c);try{var b=c[0].clientWidth;return 100-(b==100||b==0?83:b)}finally{c.remove()}},j=d.monitor===window||d.monitor===a(window)?0:i();return this.each(function(){new b(a(this),d,j)})};a.fn.rsOverview.defaults={monitor:a(window),center:true,autoHide:false,readonly:false,scrollSpeed:"normal",bookmarkClass:"bookm",bookmarkActiveClass:"active",bookmarkHint:"Go to bookmark",contentClass:"content",viewportClass:"viewport",onCreate:null,onChangeCtrlState:null,onChangeToggle:null}})(jQuery)