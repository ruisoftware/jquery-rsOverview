(function(a){var b=function(e,b,j){var n=e.children("div"),h=n.eq(0),g=n.eq(1),c={coef:0,scrPixels:{x:j,y:j}},f={$obj:null,sizeX:0,sizeY:0,resized:function(){this.sizeX=this.$obj.width();this.sizeY=this.$obj.height()},resizedOverflow:function(){var a=this.$obj[0].children.length==1?this.$obj[0].children[0].children.length>0?this.$obj[0].children[0]:this.$obj[0]:this.$obj[0];this.sizeX=a.scrollWidth;this.sizeY=a.scrollHeight}},d={$obj:null,sizeX:0,sizeY:0,resized:function(){this.sizeX=this.$obj.width();this.sizeY=this.$obj.height()}},i={states:{toggle:null,triggerToggle:function(c,a){if(b.onChangeToggle&&a!==this.toggle){this.toggle=a;b.onChangeToggle(c,this.toggle)}},prev:null,triggerPrev:function(c,a){if(b.onChangeCtrlState&&a!==this.prev){this.prev=a;b.onChangeCtrlState(c,"prev",this.prev)}},next:null,triggerNext:function(c,a){if(b.onChangeCtrlState&&a!==this.next){this.next=a;b.onChangeCtrlState(c,"next",this.next)}},clearAll:null,triggerClearAll:function(c,a){if(b.onChangeCtrlState&&a!==this.clearAll){this.clearAll=a;b.onChangeCtrlState(c,"clear",this.clearAll)}}},currIdx:0,qt:0,marks:[],getPnt:function(b){var a=b.split("#");return[parseInt(a[0],10),parseInt(a[1],10)]},checkEvents:function(a){if(b.onChangeCtrlState)if(this.currIdx===-1){this.states.triggerPrev(a,false);this.states.triggerNext(a,false);this.states.triggerClearAll(a,false)}else{this.states.triggerPrev(a,true);this.states.triggerNext(a,this.currIdx<this.qt-1);this.states.triggerClearAll(a,true)}this.states.triggerToggle(a,this.isMarked())},doToggle:function(e,l,m){var j=l+"#"+m,c=a.inArray(j,this.marks);if(c===-1){this.marks.push(j);var k=[g.position().left-h.position().left,g.position().top-h.position().top],f=[g.width()/2,g.height()/2],d=a("<div />").addClass(b.bookmarkClass.replace(/^[.]/,"")).appendTo(h),i=[d.outerWidth(),d.outerHeight()];d.css({position:"absolute",left:(k[0]+f[0]-i[0]/2).toFixed(0)+"px",top:(k[1]+f[1]-i[1]/2).toFixed(0)+"px"});this.qt=this.marks.length;this.currIdx=this.qt-1}else{this.marks.splice(c,1);a(b.bookmarkClass+":eq("+c+")",h).remove();this.qt=this.marks.length;this.currIdx=c-1}e&&this.checkEvents(e)},toggle:function(a){this.doToggle(a,f.$obj.scrollLeft(),f.$obj.scrollTop())},doClearAll:function(c){this.marks.length=0;this.qt=0;this.currIdx=-1;a(b.bookmarkClass,h).remove();c&&this.checkEvents(c)},clearAll:function(a){this.doClearAll(a)},go:function(c){if(c>-1&&c<this.qt){var d=this.getPnt(this.marks[c]);(b.viewport===window?a("html,body"):f.$obj).animate({scrollLeft:d[0],scrollTop:d[1]},b.scrollSpeed);return true}return false},beforeGo:function(b){var a=this.getMarkedIdx();if(a!==-1)this.currIdx=a+b;if(this.currIdx<0)this.currIdx=0;if(this.currIdx>this.qt-1)this.currIdx=this.qt-1},gotoPrev:function(c){this.beforeGo(-1);var a=this.go(this.currIdx);if(a){if(b.onChangeCtrlState){this.currIdx===0&&this.states.triggerPrev(c,false);this.states.triggerNext(c,true)}--this.currIdx}return a},gotoNext:function(c){this.beforeGo(+1);var a=this.go(this.currIdx);if(a){if(b.onChangeCtrlState){this.currIdx===this.qt-1&&this.states.triggerNext(c,false);this.states.triggerPrev(c,true)}++this.currIdx}return a},getMarkedIdx:function(){return a.inArray(f.$obj.scrollLeft()+"#"+f.$obj.scrollTop(),this.marks)},isMarked:function(){return this.getMarkedIdx()>-1},parseLoad:function(b){var e=[];if(b)if(b instanceof Array)for(var f in b){var c=b[f];if(c){try{var a=c.split("#")}catch(g){a=null}if(a&&a.length===2){var d=[parseInt(a[0],10),parseInt(a[1],10)];if(!isNaN(d[0])&&!isNaN(d[1])){e.push(d);continue}}}throw"Invalid element "+c+" at index "+f+'. Expected a "x#y" string object, where x and y are integers. Example: ["0#0","40#80","40#300"]';}else throw'Expected an array of strings "x#y", where x and y are integers. Example: ["0#0","40#80","40#300"]';return e},loadMarks:function(f,d){try{var a=this.parseLoad(d);this.doClearAll(null);for(var c in a)this.doToggle(null,a[c][0],a[c][1]);e.trigger("resize.rsOverview");this.checkEvents(f)}catch(g){var b="rsOverview.loadMarks(): "+g;if(window.console)console.error(b);else alert(b)}}},k=function(){return f.sizeX<=d.sizeX?0:c.scrPixels.x},l=function(){return f.sizeY<=d.sizeY?0:c.scrPixels.y},t=function(){if(b.viewport===window)f.resized();else{f.resizedOverflow();var o=[d.$obj.css("overflow-x"),d.$obj.css("overflow-y")];c.scrPixels.x=o[0]=="hidden"?0:j;c.scrPixels.y=o[1]=="hidden"?0:j}d.resized();if(b.autoHide){if(f.sizeX<=d.sizeX&&f.sizeY<=d.sizeY){e.hide();return}e.show()}else e.is(":hidden")&&e.show();var a={x:e.width(),y:e.height()},g=f.sizeX/a.x,i=f.sizeY/a.y;c.coef=Math.max(g,i);g=(d.sizeX-l())/a.x;i=(d.sizeY-k())/a.y;c.coef=Math.max(Math.max(g,i),c.coef);var n=f.sizeX/c.coef,m=f.sizeY/c.coef;h.width(n).height(m).css({left:(b.center?(a.x-n)/2:0).toFixed(0)+"px",top:(b.center?(a.y-m)/2:0).toFixed(0)+"px"});e.trigger("render.rsOverview")},s=function(o){var j=(d.sizeX-l())/c.coef,f=(d.sizeY-k())/c.coef;g.width(j).height(f).css({left:(d.$obj.scrollLeft()/c.coef+(b.center?h.position().left:0)).toFixed(1)+"px",top:(d.$obj.scrollTop()/c.coef+(b.center?h.position().top:0)).toFixed(1)+"px"});for(var n in i.marks){var m=i.getPnt(i.marks[n]),e=a(b.bookmarkClass+":eq("+n+")",h);e.css({left:((j-e.outerWidth())/2+m[0]/c.coef).toFixed(0)+"px",top:((f-e.outerHeight())/2+m[1]/c.coef).toFixed(0)+"px"})}b.bookmarkClass&&i.states.triggerToggle(o,i.isMarked())},r=function(a){b.bookmarkClass&&i.toggle(a)},o=function(a){b.bookmarkClass&&i.clearAll(a)},q=function(a){b.bookmarkClass&&i.gotoPrev(a)},p=function(a){b.bookmarkClass&&i.gotoNext(a)},m=function(c,a){switch(a){case"bookmarks":return i.marks;case"readonly":return b.readonly;case"center":return b.center;case"autoHide":return b.autoHide;case"scrollSpeed":return b.scrollSpeed}return null},u=function(c,d,a){switch(d){case"bookmarks":b.bookmarkClass&&i.loadMarks(c,a);break;case"readonly":b.readonly=a;break;case"center":b.center=a;e.trigger("resize.rsOverview");break;case"autoHide":b.autoHide=a;e.trigger("resize.rsOverview");break;case"scrollSpeed":b.scrollSpeed=a}return m(c,d)},v=function(){d.$obj=a(b.viewport);if(b.viewport===window)f.$obj=a(document);else f.$obj=d.$obj;d.$obj.scroll(function(){e.trigger("render.rsOverview")}).resize(function(){e.trigger("resize.rsOverview")});g.mousedown(function(f){if(!b.readonly){var a={initPos:g.offset(),initClick:{X:f.pageX,Y:f.pageY}};this.onselectstart=function(){return false};g.bind("mousemove.rsOverview",function(f){var b=[e.position(),h.position()];d.$obj.scrollLeft(c.coef*(f.pageX-a.initClick.X+a.initPos.left-b[0].left-b[1].left)).scrollTop(c.coef*(f.pageY-a.initClick.Y+a.initPos.top-b[0].top-b[1].top))});f.preventDefault()}});a("body").mouseup(function(){!b.readonly&&g.unbind("mousemove.rsOverview")});h.mousedown(function(i){if(!b.readonly){var f=[e.position(),a(this).position()];if(b.viewport===window){var h=[a("html").scrollLeft(),a("html").scrollTop()],j=[c.coef*(i.pageX-f[0].left-f[1].left-g.width()/2),c.coef*(i.pageY-f[0].top-f[1].top-g.height()/2)],k=h[0]!=0||h[1]!=0;if(h[0]===0&&h[1]===0){h[0]=a("body").scrollLeft();h[1]=a("body").scrollTop()}a("html,body").animate({scrollLeft:j[0],scrollTop:j[1]},b.scrollSpeed)}else d.$obj.animate({scrollLeft:c.coef*(i.pageX-f[0].left-f[1].left-g.width()/2),scrollTop:c.coef*(i.pageY-f[0].top-f[1].top-g.height()/2)},b.scrollSpeed);i.preventDefault()}});h.css("overflow","hidden");e.bind("resize.rsOverview",t).bind("render.rsOverview",s).bind("bookmarkToggle.rsOverview",r).bind("bookmarkClearAll.rsOverview",o).bind("bookmarkGotoPrev.rsOverview",q).bind("bookmarkGotoNext.rsOverview",p).bind("getter.rsOverview",m).bind("setter.rsOverview",u);e.trigger("resize.rsOverview")};v()};a.fn.rsOverview=function(c){var e=function(){return this.trigger("resize.rsOverview")},i=function(){return this.trigger("bookmarkToggle.rsOverview")},f=function(){return this.trigger("bookmarkClearAll.rsOverview")},h=function(){return this.trigger("bookmarkGotoPrev.rsOverview")},g=function(){return this.trigger("bookmarkGotoNext.rsOverview")},k=function(){if(typeof arguments[0]=="string"){var a=arguments.length==1?"getter":arguments.length==2?"setter":null;if(a!=null)return this.eq(0).triggerHandler(a+".rsOverview",arguments)}};if(typeof c=="string"){var j=Array.prototype.slice.call(arguments,1);switch(c){case"contentSizeChanged":return e.apply(this);case"bookmarkToggle":return i.apply(this);case"bookmarkClearAll":return f.apply(this);case"bookmarkGotoPrev":return h.apply(this);case"bookmarkGotoNext":return g.apply(this);case"option":return k.apply(this,j);default:return this}}var d=a.extend({},a.fn.rsOverview.defaults,c);getScrollbarSize=function(){var c=a("<div style='visibily: hidden; overflow: scroll; width: 100px;'></div>");a("body").append(c);try{var b=c[0].clientWidth;return 100-(b==100||b==0?83:b)}finally{c.remove()}},scrollbarPixels=d.viewport===window?0:getScrollbarSize();return this.each(function(){new b(a(this),d,scrollbarPixels)})};a.fn.rsOverview.defaults={viewport:window,center:true,autoHide:false,readonly:false,scrollSpeed:"medium",bookmarkClass:".bookm",onChangeCtrlState:null,onChangeToggle:null}})(jQuery)